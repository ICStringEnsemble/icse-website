{% extends 'IcsePublicBundle:Default:template.html.twig' %}
{% set currentSection = 'home' %}

{% block stylesheets %}
{{ parent() }}
{% stylesheets 
  '@IcsePublicBundle/Resources/style/home.scss' 
  filter='compass,css_url_rewrite,?yui_css'
  output='bundles/icsepublic/css/home.css'
%}
<link rel="stylesheet" type="text/css" media="screen" href="{{ asset_url }}" />
{% endstylesheets %}
{% endblock %} 

{% block javascripts %}
{{ parent() }}
<script src="{{ asset('bundles/icsepublic/js/lib/jquery.cycle.min.js') }}"></script> 
<script src="{{ asset('bundles/icsepublic/js/lib/jquery.waitforimages.min.js') }}"></script> 
<script src="{{ asset('bundles/icsepublic/js/lib/jquery.timeago.min.js') }}"></script> 
{% endblock %} 

{% block content %}

<div id=col_left>
  {% autoescape false %} 
  {{ home_intro }}
  {% endautoescape %}
  {% set includedEventList = false %}

  {% for event_group in [{label:"Today", events:today_events},
                         {label:"Tomorrow", events:tomorrow_events},
                         {label:((today_events or tomorrow_events)
                               ?"Later This Week":"This Week"), events:thisweek_events},
                         {label:"Next Week", events:nextweek_events},
                         {label:((today_events or tomorrow_events or thisweek_events or nextweek_events)
                               ?"Other Upcoming Events":"Upcoming Events"), url:path('IcsePublicBundle_future_events'), events:future_events}] %}
    {% if event_group.events %}
      {% if event_group.url is defined %}
        <h2><a href="{{ event_group.url }}">{{ event_group.label }}</a></h2>
      {% else %}
        <h2>{{ event_group.label }}</h2>
      {% endif %}
      {% include 'IcsePublicBundle:Events:event_list_fragment.html.twig' with {'events': event_group.events, 'firstInclude': not includedEventList} %}
      {% set includedEventList = true %}
    {% endif %}
  {% endfor %}
  <h2><a href="{{ path('IcsePublicBundle_past_events') }}">Previous Events</a></h2>
  <div id="past_events_strip">
  {% spaceless %} 
  {% for event in past_events %}
      <a href="{{ path('IcsePublicBundle_event', event) }}" title="{{ event.getName() }}" >
        <img alt="{{ event.getName() }}" src="{{ path('IcsePublicBundle_resource', {'type':'images', 'file':event.getPoster().getFile(), 'size':'hpimagestrip'}) }}" />
      </a>
  {% endfor %}
  {% endspaceless %} 
  </div>
  <div id="past_events_more"><a href="{{ path('IcsePublicBundle_past_events') }}">more...</a></div>
  <div id="past_event_title"></div>
</div>

<script>
  $('#past_events_strip a').each(function(){
    $(this).data('title', $(this).attr('title')).removeAttr('title'); 
  });

  $('#past_events_strip a').hover(function(){
    $('#past_event_title').html($(this).data('title'));
  }, function(){
    $('#past_event_title').html('');
  });

  $('#past_events_strip').waitForImages(function() {
    var images = $('#past_events_strip img');
    var originalWidth = 0;
    var originalWidthIE = 0;
    var onloadsCompleted = 0;
    var requiredWidth = 580;
    images.each(function() {
      var origImg = new Image(); 
      origImg.onload = (function(visibleImg) {
        return function(){
          originalWidthIE += this.width;
          $(visibleImg).data('origWidth', this.width);
          onloadsCompleted += 1;
          if (onloadsCompleted === images.size()) {
            scaleFactor = requiredWidth / originalWidthIE;
            if (scaleFactor > 1) scaleFactor = 1;
            images.each(function(){
              $(this).width($(this).data('origWidth')*scaleFactor);
            });
          }
        }
      })(this);
      origImg.src = $(this).attr('src'); 
    });
  }); 
</script>

<div id=col_right>
  <div id=slideshow >
    {% for image in slideshow_images %}
    <img width=334 height=254 src="{{ path('IcsePublicBundle_resource', {'type':'images', 'file':image.getFile(), 'size':'hpslideshow'}) }}"/>
    {% endfor %}
  </div>
  <script>
    $('#slideshow').cycle({ 
        fx:     'fadeout', 
        random:  1 
    }); 
  </script>


  {% if next_rehearsal %}
  <h2>Next Rehearsal</h2>
  <div id="next_rehearsal">
  <div class="datetime">{{ next_rehearsal.getStartsAt() | date("l jS F Y, g:ia") }}</div>
  {% if next_rehearsal.getLocation() %}
  <div class="location">{{ next_rehearsal.getLocation().getName() }}</div>
  {% endif %}
  </div>
  {% endif %}

  {% if news_articles is not empty %}
  <h2>News</h2>
  {% include 'IcsePublicBundle:News:news_list_fragment.html.twig' with {'articles': news_articles, 'img_size': 'hpsidethumb'} %}  
  {% endif %}

  <h2>Facebook</h2>
  <iframe id="facebook_widget" src="//www.facebook.com/plugins/likebox.php?href=http%3A%2F%2Fwww.facebook.com%2FImperialCollegeStringEnsemble&amp;width=334&amp;height=290&amp;show_faces=true&amp;colorscheme=light&amp;stream=false&amp;border_color&amp;header=true" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:334px; height:290px;" allowTransparency="true"></iframe>

  <h2>Follow Us</h2>
  <a href="https://twitter.com/icstrings" class="twitter-follow-button" data-show-count="false">Follow @icstrings</a>
  <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script> 
  <div class="g-plus" data-width="334" data-height="69" data-href="//plus.google.com/103940088893023414758" data-rel="publisher"></div>
  <script type="text/javascript">
    window.___gcfg = {lang: 'en-GB'};

    (function() {
      var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
      po.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
    })();
  </script> 

 
</div>

{% endblock %}
