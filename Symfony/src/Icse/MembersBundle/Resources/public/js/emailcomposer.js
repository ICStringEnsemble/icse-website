(function(){$(".email_buttons button").button();var k=$("#preview_dialog");var g=$("#editable");var n=$("#icse_email");k.dialog({autoOpen:false,modal:true,resizable:true,width:800,height:500});g.ckeditor(function(){},{extraPlugins:"webkit-span-fix,sourcedialog",customConfig:"",extraAllowedContent:"*[id](*)",toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline","-","RemoveFormat"]},{name:"paragraph",items:[]},{name:"insert",items:["NumberedList","BulletedList","-","Link","Image","HorizontalRule"]},"/",{name:"styles",items:["Format"]},{name:"editing",items:["Sourcedialog","-","Scayt"]},{name:"tools",items:["Maximize","ShowBlocks","-","About"]}],width:490});function o(w,v,t){var s=$.Deferred();var u=$("<div>").html(w).dialog({close:function(){},resizable:false,modal:true,width:400,buttons:{s:function(){}}});var r=u.parent().find(".ui-dialog-buttonset");u.dialog("option","buttons",[{text:v,click:function(){$(".email_buttons .loading_spinner").clone().prependTo(r).show();r.find("button").button("disable");var x=t();x.done(function(){u.dialog("close");s.resolve()}).fail(function(){r.find(".loading_spinner").remove();r.find("button").button("enable")})}},{text:"Cancel",click:function(){u.dialog("close")}}]);return s.promise()}function q(){var s="test";try{localStorage.setItem(s,s);localStorage.removeItem(s);return true}catch(r){return false}}var h;var p=$("#email_options_pane");var c=p.find("input[name=mailing_list]");var d=p.find("input[name=send_to_option]");var a=function(){};var f=function(){};if(q()){var e=$.initNamespaceStorage("icse_email_draft").localStorage;function i(){var u=e.get("body");if(u){u=$("<div>").append(u);var t=$("<div>").append(g.ckeditorGet().getData());var r=t.find("#email_upcoming_rehearsals");var s=u.find("#email_upcoming_rehearsals");if(s.length){s.replaceWith(r)}else{u.append(r)}g.ckeditorGet().setData(u.html())}h=e.get(["subject","mailing_list","send_to_option","send_to_address"]);if(h.email_subject){p.find("#email_subject").val(h.subject)}if(h.send_to_address){p.find("#send_to_address").val(h.send_to_address)}if(h.mailing_list){c.filter("[value="+h.mailing_list+"]").prop("checked",true)}if(h.send_to_option){d.filter("[value="+h.send_to_option+"]").prop("checked",true)}}i();a=function(){var r=g.ckeditorGet().getData();e.set("body",r);$(".saved_indicator").show()};f=function(){e.set(h);e.remove("subject")}}var m;g.ckeditorGet().on("change",function(){$(".saved_indicator").hide();clearTimeout(m);m=setTimeout(a,1000)});p.find("#send_to_address").tagit({availableTags:["icse@imperial.ac.uk"],autocomplete:{delay:0,minLength:1}});var b=p.find("#send_to_row").find("ul.tagit");function l(){var t=p.find("#email_subject").val();var r=p.find("#send_to_address").val();var s=c.filter(":checked").val();if(s=="none"){d.filter("[value=mailing_list]").prop("disabled",true);d.filter("[value=other]").prop("checked",true)}else{d.filter("[value=mailing_list]").prop("disabled",false)}var u=d.filter(":checked").val();if(u=="other"){b.removeClass("disabled")}else{b.addClass("disabled")}h={email_subject:t,mailing_list:s,send_to_option:u,send_to_address:r};f();n.find("[class^=ml_]").hide();n.find("[class^=ml_"+h.mailing_list+"]").show()}l();p.find("input").change(l);b.click(function(){d.filter("[value=other]").prop("checked",true);l()});function j(){var r={body:g.ckeditorGet().getData()};$.extend(r,h);return r}$("button.preview").click(function(){k.dialog("open");k.html($(".email_buttons .loading_spinner").clone().removeAttr("hidden"));k.load(k.data("base-url"),j())});$("button.send").click(function(){o("Send email?","Send",function(){var r=$.Deferred();var s=$("button.send").data("base-url");$.ajax({type:"POST",data:j(),url:s,dataType:"json"}).always(function(t){if(t.status=="success"){r.resolve()}else{r.reject()}});return r})})})();