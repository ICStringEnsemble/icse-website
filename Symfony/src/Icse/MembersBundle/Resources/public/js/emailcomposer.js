(function(){$(".email_buttons button").button();var e=$("#preview_dialog");var t=$("#editable");var i=$("#icse_email");e.dialog({autoOpen:false,modal:true,resizable:true,width:800,height:500});t.ckeditor(function(){},{extraPlugins:"webkit-span-fix,sourcedialog",customConfig:"",extraAllowedContent:"*[id](*)",toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline","-","RemoveFormat"]},{name:"paragraph",items:[]},{name:"insert",items:["NumberedList","BulletedList","-","Link","Image","HorizontalRule"]},"/",{name:"styles",items:["Format"]},{name:"editing",items:["Sourcedialog","-","Scayt"]},{name:"tools",items:["Maximize","ShowBlocks","-","About"]}],width:490});function a(e,t,i){var a=$.Deferred();var n=$("<div>").html(e).dialog({close:function(){},resizable:false,modal:true,width:400,buttons:{s:function(){}}});var o=n.parent().find(".ui-dialog-buttonset");n.dialog("option","buttons",[{text:t,click:function(){$(".email_buttons .loading_spinner").clone().prependTo(o).show();o.find("button").button("disable");var e=i();e.done(function(){n.dialog("close");a.resolve()}).fail(function(){o.find(".loading_spinner").remove();o.find("button").button("enable")})}},{text:"Cancel",click:function(){n.dialog("close")}}]);return a.promise()}function n(){var e="test";try{localStorage.setItem(e,e);localStorage.removeItem(e);return true}catch(t){return false}}var o;var l=$("#email_options_pane");var r=l.find("input[name=mailing_list]");var s=l.find("input[name=send_to_option]");var d=function(){};var c=function(){};if(n()){var u=$.initNamespaceStorage("icse_email_draft").localStorage;function f(){var e=u.get("body");if(e){e=$("<div>").append(e);var i=$("<div>").append(t.ckeditorGet().getData());var a=i.find("#email_upcoming_rehearsals");var n=e.find("#email_upcoming_rehearsals");if(n.length){n.replaceWith(a)}else{e.append(a)}t.ckeditorGet().setData(e.html())}o=u.get(["subject","mailing_list","send_to_option","send_to_address"]);if(o["email_subject"]){l.find("#email_subject").val(o["subject"])}if(o["send_to_address"]){l.find("#send_to_address").val(o["send_to_address"])}if(o["mailing_list"]){r.filter("[value="+o["mailing_list"]+"]").prop("checked",true)}if(o["send_to_option"]){s.filter("[value="+o["send_to_option"]+"]").prop("checked",true)}}f();d=function(){var e=t.ckeditorGet().getData();u.set("body",e);$(".saved_indicator").show()};c=function(){u.set(o);u.remove("subject")}}var m;t.ckeditorGet().on("change",function(){$(".saved_indicator").hide();clearTimeout(m);m=setTimeout(d,1e3)});l.find("#send_to_address").tagit({availableTags:["icse@imperial.ac.uk"],autocomplete:{delay:0,minLength:1}});var _=l.find("#send_to_row").find("ul.tagit");function v(){var e=l.find("#email_subject").val();var t=l.find("#send_to_address").val();var a=r.filter(":checked").val();if(a=="none"){s.filter("[value=mailing_list]").prop("disabled",true);s.filter("[value=other]").prop("checked",true)}else{s.filter("[value=mailing_list]").prop("disabled",false)}var n=s.filter(":checked").val();if(n=="other"){_.removeClass("disabled")}else{_.addClass("disabled")}o={email_subject:e,mailing_list:a,send_to_option:n,send_to_address:t};c();i.find("[class^=ml_]").hide();i.find("[class^=ml_"+o["mailing_list"]+"]").show()}v();l.find("input").change(v);_.click(function(){s.filter("[value=other]").prop("checked",true);v()});function p(){var e={body:t.ckeditorGet().getData()};$.extend(e,o);return e}$("button.preview").click(function(){e.dialog("open");e.html($(".email_buttons .loading_spinner").clone().removeAttr("hidden"));e.load(e.data("base-url"),p())});$("button.send").click(function(){a("Send email?","Send",function(){var e=$.Deferred();var t=$("button.send").data("base-url");$.ajax({type:"POST",data:p(),url:t,dataType:"json"}).always(function(t){if(t.status=="success"){e.resolve()}else{e.reject()}});return e})})})();