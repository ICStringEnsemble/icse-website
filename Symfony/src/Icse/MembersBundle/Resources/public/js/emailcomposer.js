(function(){$(".email_buttons button").button();var e=$("#preview_dialog");var t=$("#editable");var i=$("#icse_email");var a=$("#ckeditor_localdir").attr("href");e.dialog({autoOpen:false,modal:true,resizable:true,width:800,height:500});CKEDITOR.plugins.addExternal("webkit-span-fix",a+"/plugins/webkit-span-fix/","plugin.js");t.ckeditor(function(){},{extraPlugins:"webkit-span-fix,sourcedialog,image2,entities",customConfig:"",extraAllowedContent:"*[id](*)",toolbar:[{name:"basicstyles",items:["Bold","Italic","Underline","-","RemoveFormat"]},{name:"paragraph",items:[]},{name:"insert",items:["NumberedList","BulletedList","-","Link","Image","HorizontalRule"]},"/",{name:"styles",items:["Format"]},{name:"editing",items:["Sourcedialog","-","Scayt"]},{name:"tools",items:["Maximize","ShowBlocks","-","About"]}],width:490,image2_alignClasses:["image-left","image-center","image-right"],image2_captionedClass:"image-captioned",entities_processNumerical:true});function n(e,t,i){var a=$.Deferred();var n=$("<div>").html(e).dialog({close:function(){},resizable:false,modal:true,width:400,buttons:{s:function(){}}});var o=n.parent().find(".ui-dialog-buttonset");n.dialog("option","buttons",[{text:t,click:function(){$(".email_buttons .loading_spinner").clone().prependTo(o).show();o.find("button").button("disable");var e=i();e.done(function(){n.dialog("close");a.resolve()}).fail(function(){o.find(".loading_spinner").remove();o.find("button").button("enable")})}},{text:"Cancel",click:function(){n.dialog("close")}}]);return a.promise()}function o(){var e="test";try{localStorage.setItem(e,e);localStorage.removeItem(e);return true}catch(t){return false}}var l;var r=$("#email_options_pane");var s=r.find("input[name='form[mailing_list]']");var d=r.find("input[name='form[send_to_option]']");var c=function(){};var u=function(){};if(o()){var f=$.initNamespaceStorage("icse_email_draft").localStorage;function m(){var e=f.get("body");if(e){e=$("<div>").append(e);var i=$("<div>").append(t.ckeditorGet().getData());var a=i.find("#email_upcoming_rehearsals");var n=e.find("#email_upcoming_rehearsals");if(n.length){n.replaceWith(a)}else{e.append(a)}t.ckeditorGet().setData(e.html())}l=f.get(["subject","mailing_list","send_to_option","send_to_address"]);if(l["email_subject"]){r.find("#email_subject").val(l["subject"])}if(l["send_to_address"]){r.find("#send_to_address").val(l["send_to_address"])}if(l["mailing_list"]){s.filter("[value="+l["mailing_list"]+"]").prop("checked",true)}if(l["send_to_option"]){d.filter("[value="+l["send_to_option"]+"]").prop("checked",true)}}m();c=function(){var e=t.ckeditorGet().getData();f.set("body",e);$(".saved_indicator").show()};u=function(){f.set(l);f.remove("subject")}}var _;t.ckeditorGet().on("change",function(){$(".saved_indicator").hide();clearTimeout(_);_=setTimeout(c,1e3)});r.find("#send_to_address").tagit({availableTags:["icse@imperial.ac.uk"],autocomplete:{delay:0,minLength:1}});var p=r.find("#send_to_row").find("ul.tagit");function v(){var e=r.find("#email_subject").val();var t=r.find("#send_to_address").val();var a=s.filter(":checked").val();if(a=="none"){d.filter("[value=mailing_list]").prop("disabled",true);d.filter("[value=other]").prop("checked",true)}else{d.filter("[value=mailing_list]").prop("disabled",false)}var n=d.filter(":checked").val();if(n=="other"){p.removeClass("disabled")}else{p.addClass("disabled")}l={email_subject:e,mailing_list:a,send_to_option:n,send_to_address:t};u();i.find("[class^=ml_]").hide();i.find("[class^=ml_"+l["mailing_list"]+"]").show()}v();r.find("input").change(v);p.click(function(){d.filter("[value=other]").prop("checked",true);v()});function g(){r.find("#form_body").val(t.ckeditorGet().getData());return r.find("form").serialize()}$("button.preview").click(function(){e.dialog("open");e.html($(".email_buttons .loading_spinner").clone().removeAttr("hidden"));e.load(e.data("base-url"),g())});$("button.send").click(function(){n("Send email?","Send",function(){var e=$.Deferred();var t=$("button.send").data("base-url");$.ajax({type:"POST",data:g(),url:t,dataType:"json"}).always(function(t){if(t.status=="success"){e.resolve()}else{e.reject()}});return e})})})();