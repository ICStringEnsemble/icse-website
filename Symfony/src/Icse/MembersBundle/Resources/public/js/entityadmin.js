(function(){var t=$(".doceditor");var e=$("#bundles_basedir").attr("href");var i=$("#main_stylesheet").attr("href");var n="sourcedialog,image2,entities,autogrow";["webkit-span-fix","heading-button"].forEach(function(t){CKEDITOR.plugins.addExternal(t,e+"/icsemembers/lib/ckeditor/plugins/"+t+"/","plugin.js");n+=","+t});t.each(function(){var t="Sourcedialog";var e="";var o="";if($(this).is("textarea")){t="Source";e=i;o="icseeditorcontent";if($(this).hasClass("newsarticleeditor")){o+=" newsarticleeditor"}}$(this).ckeditor(function(){},{extraPlugins:n,customConfig:"",extraAllowedContent:"*[id](*)",toolbar:[{name:"styles",items:["HeadingButton"]},{name:"basicstyles",items:["Bold","Italic","-","RemoveFormat"]},{name:"editing",items:["Scayt","-",t]},"/",{name:"styles2",items:["Format"]},{name:"insert",items:["NumberedList","BulletedList","-","Link","Image","HorizontalRule"]},{name:"tools",items:["ShowBlocks","-","About"]}],image2_alignClasses:["image-left","image-center","image-right"],image2_captionedClass:"image-captioned",entities_processNumerical:true,contentsCss:e,bodyClass:o})});function o(t){this.ckeditor=t.ckeditorGet()}o.prototype.getContent=function(){return this.ckeditor.getData()};o.prototype.setContent=function(t){return this.ckeditor.setData(t)};o.prototype.onChange=function(t){return this.ckeditor.on("change",t)};$.fn.icseDocEditor=function(){return new o(this)}})();
(function(){if(typeof initCreateForm!="function"){window.initCreateForm=function(){}}if(typeof initEditForm!="function"){window.initEditForm=function(){}}if(typeof postTableReload!="function"){window.postTableReload=function(){}}function t(t){t.wrap("<form>").parent()[0].reset();t.unwrap()}function e(t){if(t.data("label")){var e=$("<span>",{"class":"fileinput-button-wrapper "+t.attr("class")});e.append($("<span>",{text:t.data("label")}));e.insertAfter(t);e.button();t.detach().appendTo(e)}}$("button").button();$('input[type="file"]').each(function(){e($(this))});$("input.time").timepicker({timeFormat:"g:i a"});$("input.date").datepicker({dateFormat:"dd/mm/yy"});$("#edit_form input:submit, #import_csv_form input:submit").hide();$("form").each(function(){if($(this).find('input[type!="hidden"]').first().is(".date, .time")){$(this).before('<input type="text" style="width: 0; height: 0; top: -100px; position: absolute;">')}});var n=$("#edit_form");if(n.find('input[name="_method"]').length==0){n.find("input:submit").before('<input type=hidden name="_method" value="POST" >')}n.find("div.end_time_widget").each(function(){var t=$(this);var e=t.find("input.duration");var n=t.find(".end_time_indicator");var i=t.find(".indicator_area");var a=t.find("input.end_time");var o=t.closest("form > *").prevAll(":has(input.time):first");var r=o.find("input.date");var s=o.find("input.time");var l=e.add(r).add(s);var d=function(t){if(t===null){i.hide()}else{n.text(t.format("h:mm a"));i.show()}};l.on("input change",function(){var t=s.val();var n=r.val();var i=$.trim(e.val());var o=i.split(":");var l=o[0];var c=o[1];if(t&&n&&(l||c)&&(!l||!isNaN(l))&&(!c||!isNaN(c))){var f=moment(n+" "+t,"DD/MM/YYYY hh:mm a");f.add(o[0],"hours");f.add(o[1],"minutes");a.val(f.toISOString());d(f)}else{a.val("");d(null)}});a.on("change",function(){var t=s.val();var n=r.val();var i=a.val();if(t&&n&&i){var o=moment(n+" "+t,"DD/MM/YYYY hh:mm a");var l=moment(i,moment.ISO_8601);var c=l.diff(o,"hours",true).toString();var f=c.split(".");var u=f[1];if(u&&u.length>1){var p=Math.round(("0."+u)*60);c=f[0]+":"+p}e.val(c);d(l)}else{e.val(null);d(null)}})});var i=$("html");i.on("dragenter",function(t){t.preventDefault();t.stopPropagation()});i.on("dragover",function(t){t.preventDefault();t.stopPropagation()});i.on("dragleave",function(t){t.preventDefault();t.stopPropagation()});i.on("drop",function(t){t.preventDefault();t.stopPropagation()});if(typeof fos!="undefined"&&typeof fos.Router!="undefined"){fos.Router.prototype.generateIgnoringExtras=function(t,e,n){var i=this.generate(t,e,n);return i.replace(/\?.*$/,"")}}(function(){var t=$(".entity_main_buttons");t.height(t.height());t.waypoint("sticky",{offset:window.location.hash=="#alt1"?"5px":"0"});if(["#alt1","#alt2"].indexOf(window.location.hash)>=0){t.addClass(window.location.hash.slice(1))}})();var a;var o;(function(){var t=0;a=function(){t+=1;$(".entity_main_buttons .loading_spinner").show()};o=function(){t-=1;if(t==0){$(".entity_main_buttons .loading_spinner").hide()}}})();$.fn.isAnyEntityInstanceSelected=function(){return $(this).hasClass("ui-selected")};$.fn.isExactlyOneEntityInstanceSelected=function(){return $(this).filter(".ui-selected").length==1};function r(t){if(typeof t==="undefined")t=200;var e=$(".entity_instance_list .instance");if(!e.isAnyEntityInstanceSelected()){$(".show_if_none_selected").show(t);$(".show_if_one_selected, .show_if_any_selected").hide(t)}else if(e.isExactlyOneEntityInstanceSelected()){$(".show_if_one_selected, .show_if_any_selected").show(t);$(".show_if_none_selected").hide(t)}else{$(".show_if_any_selected").show(t);$(".show_if_none_selected, .show_if_one_selected").hide(t)}}r(0);function s(){var t=$(".entity_instance_list");var e=t.selectable({filter:".instance",stop:r});var n=e.data("uiSelectable")["_mouseStart"];e.data("uiSelectable")["_mouseStart"]=function(t){n.call(this,t);this.helper.css({top:-1,left:-1})};t.find(".instance").dblclick(v);t.find("abbr.timeago").timeago();t.find(".instance.just_updated").removeClass("just_updated",1e3);var i=t.filter(".waterfall");if(i.length){i.masonry();var a=i.find(".instance img");a.addClass("not-loaded");a.on("load",function(){var t=/^data:/.test($(this).attr("src"));if(!t)$(this).removeClass("not-loaded")});a.lazyload()}}s();window.onNavColumnToggle=function(){$(".entity_instance_list").filter(".waterfall").masonry()};function l(){var t=$.Deferred();$("#entity_instance_list_container").load(currentPath+"/list",function(){s();postTableReload();o();r();$(".ui-widget-overlay").height($(document).height());t.resolve()});a();return t.promise()}function d(t){return $(".entity_instance_list .instance").filter(function(){return $(this).data("entity").id===t})}$.widget("ui.dialog",$.ui.dialog,{_allowInteraction:function(t){return!!$(t.target).closest('[class*="cke"]').length||this._super(t)}});var c=$("#edit_dialog");c.dialog({autoOpen:false,modal:true,width:500,minWidth:500,height:500,dialogClass:"edit_dialog",buttons:[{text:"",click:function(){var t=$("#edit_form");t.data("reopen",false);t.find("input:submit").click()},"class":"submit_button"},{text:"Cancel",click:function(){$(this).dialog("close")},"class":"cancel_button"}],resizeStop:function(t,e){c.find(".doceditor").ckeditor().editor.execCommand("autogrow")}});function f(){I().done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").show();$(".delete_dialog .ui-dialog-buttonset button").button("disable");var t=false;var e=$(".entity_instance_list .instance.ui-selected").map(function(){var e=$(this).data("entity").id;var n=$.Deferred();$.ajax({type:"POST",data:{_method:"DELETE",fb:D},url:currentPath+"/"+e,dataType:"json"}).always(function(e){if(e.status!="success"){t=true}n.resolve()});return n.promise()});$.when.apply(null,e).done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").hide();$(".delete_dialog .ui-dialog-buttonset button").button("enable");if(!t){$("#delete_dialog").dialog("close");$(".entity_instance_list .instance.ui-selected").addClass("just_deleted");l()}})})}$("#delete_dialog").dialog({autoOpen:false,resizable:false,modal:true,width:400,dialogClass:"delete_dialog",buttons:{Delete:f,Cancel:function(){$(this).dialog("close")}}});$(".entity_main_buttons .loading_spinner").clone().hide().prependTo(".ui-dialog-buttonset");var u=function(){var t=$(this);var e=t.find("option").first().val();t.val(e)};var p=n.find("input, select, textarea").not(":button, :submit, :reset").not('input[name="_method"], input[name$="[_token]"]');function h(){$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Create");$("#edit_dialog").dialog("open").dialog({title:"Add "+entitySingularTitle});n.attr("method","POST");n.find('input[name="_method"]').val("POST");n.attr("action",currentPath);p.not("select, :radio, :checkbox").val("");n.find("select").each(u);p.change();n.find("input").filter(":radio, :checkbox").prop("checked",false);n.find(".error").remove();n.find(".show_if_create").show();n.find(".show_if_edit").hide();n.data("form_mode","create");initCreateForm(n)}$("button.create").click(h);function v(){var t=$(".entity_instance_list .instance.ui-selected");if(t.length!=1)return;var e=t.first().data("entity");$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Save Changes");$("#edit_dialog").dialog("open").dialog({title:"Edit "+entitySingularTitle});n.find('input[name="_method"]').val("PUT");n.attr("method","POST");n.find(".error").remove();n.find(".show_if_edit").show();n.find(".show_if_create").hide();n.data("form_mode","edit");n.attr("action",currentPath+"/"+e.id);p.each(function(){var t=$(this).attr("name");if(typeof t==="undefined")return;var n=t.split("[");n.splice(0,1);n=$.map(n,function(t){return t.split("]")[0]});var i=n[0];var a="";if(e.hasOwnProperty(i)){a=e[i];if(a===null){}else if($(this).hasClass("date")){a=moment(parseInt(a)).format("DD/MM/YYYY")}else if($(this).hasClass("time")){a=moment(parseInt(a)).format("h:mm a");if(i=="starts_at"&&e["is_start_time_known"]===false)a=""}else if($(this).hasClass("iso_time")){a=moment(parseInt(a)).toISOString()}else if(typeof a=="object"){if(a instanceof Array)a=null;else if($(this).is("select"))a=a.id;else a=a.name}}if($(this).is(":radio, :checkbox")){if(typeof a==="boolean")$(this).prop("checked",a)}else{if(typeof a==="boolean")a=a?1:0;$(this).val(a);$(this).change()}});initEditForm(n,e)}$("button.edit").click(v);$('input.create[type="file"]').change(function(){var e=$(this).data("change-handler");e(this.files);t($(this))});$("button.refresh").click(l);$("button.unselectall, #above_footer, #signupsfilter a").click(function(){$(".entity_instance_list .instance").removeClass("ui-selected");r()});$(".entity_main_buttons button").click(function(t){t.stopPropagation()});$("button.submit_and_reopen").click(function(){var t=$(this).closest("form");t.data("reopen",true);t.find("input:submit").click();return false});$("button.delete").click(function(){$("#delete_dialog").dialog("open")});var m=function A(t,e,n){for(var i in n)if(n.hasOwnProperty(i)){var a=n[i];var o=e+"["+i+"]";if(typeof a=="string"){var r=$("<div>",{"class":"error",text:a});var s=t.find('*[name="'+o+'"]');if(s.length==0){s=t.find('*[name="'+e+'"]')}if(s.length==0){if(isNaN(i))r.text(i+": "+r.text());r.addClass("global_error").appendTo(t)}else{s.before(r)}}else if(typeof a=="object"){A(t,o,a)}}};function _(t){t.select2({allowClear:true})}function g(t){t.each(function(){var t=$(this);t.autocomplete({minLength:0,delay:0,autoFocus:true,source:[]});var e=function(e){t.autocomplete("option","source",e)};t.data("updateSource",e)})}_($(".entity-select"));g($(".text-autosuggest"));$(".ui-dialog form").submit(function(){var t=$(this);var e=t.closest(".ui-dialog-content");var n=e.nextAll(".ui-dialog-buttonpane");var i=n.add(t).find("button");n.find(".loading_spinner").show();i.each(function(){$(this).data("was_disabled",$(this).prop("disabled"))});i.button("disable");t.find(".error").remove();var a,o,s;if(t.find("input:file").length!==0){a=new FormData(t[0]);o=false;s=false}else{a=t.serialize();o="application/x-www-form-urlencoded; charset=UTF-8";s=true}$.ajax({type:t.attr("method"),url:t.attr("action"),data:a,dataType:"json",cache:false,contentType:o,processData:s}).always(function(){n.find(".loading_spinner").hide();i.each(function(){if(!$(this).data("was_disabled")){$(this).button("enable")}})}).done(function(n){if(n.status=="success"){e.dialog("close");var i=l();if(t.data("reopen")===true){i.done(function(){var t=d(n.entity.id);t.addClass("ui-selected");r();$("button.edit").click()})}}else{if(n.status=="partial"){l()}m(t,"form",n.errors)}}).always(function(){t.data("reopen",null)});return false});function b(t,e){e.split(".").forEach(function(e){t=t[e]});return t}function y(t){t.find("li").each(function(){$(this).find("input.sort_index").val($(this).index())})}var w=function(t){var e=t.find("li").map(function(){return $(this).find("input.sort_index").val()});return e.length==0?-1:Math.max.apply(null,e)};n.find(".sortable-list").each(function(){var t=$(this);t.sortable({placeholder:"drag-placeholder",cancel:"a,.a-button,input",update:function(){y(t)}})});var x=function(t,e,n,i){i=i?i:function(){};var a=t.find(e).detach();a.find("input").removeAttr("id");a.find(".a-button.delete").click(function(){$(this).closest(e).addTransitionClass("hidden").done(function(){$(this).remove()});return false});return function(t){var e=a.clone(true);n.forEach(function(n){var i=e.find("."+n.split(".").join("_"));var a=b(t,n);if(i.is("input")){i.val(a);i.attr("name",i.attr("name").replace("__ID__",t.id))}else if(i.is("span")){i.html(a)}});i(e,t);return e}};(function(){if(n.hasClass("event")){var t=n.find("ul#performances");var e=x(t,"li.performance",["piece.id","piece.full_name","sort_index"]);var i=n.find(".performance_adder");var a=i.filter("select");var o=i.filter("div");var r=0;a.change(function(){var n=$(this).select2("data");if(n!==null){var i=n.id;var a=n.text;if(i!==""){$(this).select2("val","");o.hide();o.slideDown(300);var s=e({id:"new_"+r++,piece:{id:i,full_name:a},sort_index:w(t)+1});t.append(s)}}});window.initCreateForm=function(){t.empty();r=0};window.initEditForm=function(n,i){r=0;var a=i.performances;t.empty();a.forEach(function(n){var i=e(n);t.append(i)})}}})();(function(){if(n.hasClass("piece_of_music")){var e=n.find("#add_files_button");var i=$("#piece_of_music_add_new_part_form");var a=n.find("ul#practice_parts");i.find('input[name="form[file]"]').remove();var o;(function(){var t=a.find("li.uploading-part").detach();o=function(){var e=t.clone();e.find(".progress-bar").progressbar({value:false});return e}})();var r=x(a,"li.part",["instrument","sort_index"],function(t,e){t.find("a.open").attr("href",Routing.generateIgnoringExtras("IcsePublicBundle_resource",e))});var s=function(t,e){var n=e.find("button");var s=e.find(".loading_spinner");var d=w(a)+1;i.find('input[name="form[sort_index]"]').val(d);var c=o();c.find(".name").text(t.name);var f=c.find(".progress-bar");c.find("input.sort_index").val(d);c.hide();a.append(c);c.show(500);var u=new FormData(i[0]);u.append("form[file]",t);n.button("disable");s.show();var p=false;$.ajax({url:i.attr("action").replace("__ID__",a.data("piece_id")),type:"POST",data:u,dataType:"json",processData:false,contentType:false,xhr:function(){xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(t){if(t.lengthComputable){f.progressbar({value:t.loaded,max:t.total})}},false)}return xhr}}).done(function(t){if(t.status=="success"){var e=r(t.entity);c.replaceWith(e);p=true}}).always(function(){if(!p)c.remove();if(a.find(".uploading-part").length===0){n.button("enable");s.hide();y(a);l()}})};var d=function(t){var e=n.closest(".ui-dialog-content").nextAll(".ui-dialog-buttonpane");for(var i=0;i<t.length;i++){s(t[i],e)}};e.change(function(){d(this.files);t($(this))});var c=n.find("#practice_parts_section .drop_mask");c.data("drop-handler",d);window.initCreateForm=function(){a.empty();c.data("enabled",false)};window.initEditForm=function(t,e){c.data("enabled",true);a.data("piece_id",e.id);var n=e.practice_parts;a.empty();n.forEach(function(t){var e=r(t);a.append(e)})}}})();(function(){var t=$("#edit_form.image");if(t.hasClass("image")){var e=$("form#new_image");e.find('input[name="form[file]"]').remove();var n;(function(){var t=$("#image_prototype").detach().removeProp("hidden");n=function(){var e=t.clone();e.find(".progress-bar").progressbar({value:false});return e}})();var i=function(t){if(!t.type.match("image.*")){return}a();var i=$(".entity_instance_list");var r=n();var s=r.find(".progress-bar");i.prepend(r);var d=new FileReader;d.onloadend=function(t){r.find("img").attr("src",t.target.result);i.masonry("prepended",r);o()};d.readAsDataURL(t);var c=new FormData(e[0]);c.append("form[file]",t);$.ajax({url:e.attr("action"),type:e.attr("method"),data:c,dataType:"json",processData:false,contentType:false,xhr:function(){xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(t){if(t.lengthComputable){s.progressbar({value:t.loaded,max:t.total})}},false)}return xhr}}).always(function(){r.addClass("instance").removeClass("uploading-instance");if($(".entity_instance_list").find(".uploading-instance").length===0){console.log("reload table");l()}})};var r=function(t){for(var e=0;e<t.length;e++){i(t[e])}};$("section .drop_mask").data("drop-handler",r);$('input.create[type="file"]').data("change-handler",r)}})();(function(){var t=$(".drop_mask");t.each(function(){var t=$(this);var e=t.parent();var n=t.hasClass("height_fix");e.on("dragenter",function(){if(t.data("enabled")===true){e.addClass("draginside");if(n)t.height(e.outerHeight())}});t.on("dragleave",function(){e.removeClass("draginside")});t.on("drop",function(n){e.removeClass("draginside");var i=n.originalEvent.dataTransfer.files;var a=t.data("drop-handler");if(typeof a=="function")a(i)})})})();function k(t){var e=$.Deferred();$("<div>").html(t).dialog({close:function(){e.resolve()},resizable:false,closeOnEscape:false,buttons:{Okay:function(){$(this).dialog("close")}}});return e.promise()}function C(t){var e=$.Deferred();var n=$("<div>").html(t).dialog({resizable:false,closeOnEscape:false,open:function(){$(this).parent().find(".ui-dialog-titlebar-close").hide()},modal:true});e.always(function(){n.dialog("close")});return e}var S=false;var D=null;var T=["create_event","manage_pages"];function E(t){S=t.status==="connected"}if(enable_social_net){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_UK/all.js",function(){FB.init({appId:facebookAppId,status:true});FB.Event.subscribe("auth.authResponseChange",E);$("button.social_sync").button("option","disabled",false)})}function j(){var t=$.Deferred();FB.login(function(e){E(e);if(S){t.resolve()}else{t.reject()}},{scope:T.join(",")});return t.promise()}function F(t,e){j().done(function(){t(e)}).fail(function(){e.reject()})}function P(t){var e=$.Deferred();console.log("Already connected:",S);if(S){t($.Deferred()).done(function(){console.log("Success first time");e.resolve()}).fail(function(){k("Click to reconnect to Facebook.").always(function(){F(t,e)})})}else{F(t,e)}return e.promise()}function O(){if(D!==null){return $.when()}else{return P(function(t){FB.api("/me/accounts/",function(e){var n=false;if($.isArray(e.data))for(var i=0;i<e.data.length;i++){var a=e.data[i];if(a.id===facebookPageId){console.log(a.name,a.access_token);D=a.access_token;n=true;break}}n?t.resolve():t.reject()});return t.promise()})}}function I(){if(enable_social_net){return $.when(O())}else{return $.when()}}$("button.social_sync").button().click(function(){I().done(function(){var t=C("Synchronising changes to social networks...");var e=$(".entity_instance_list .instance.ui-selected").map(function(){var t=$(this).data("entity").id;var e=$.Deferred();$.ajax({type:"POST",url:currentPath+"/"+t+"?"+$.param({op:"socialnetsync"}),data:{fb:D},dataType:"json"}).always(function(t){if(t.status=="fail"){D=null}e.resolve()});return e.promise()});$.when.apply(null,e).done(function(){t.resolve();l()})})})})();