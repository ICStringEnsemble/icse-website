(function(){if(typeof initCreateForm!="function"){window.initCreateForm=function(){}}if(typeof initEditForm!="function"){window.initEditForm=function(){}}if(typeof postTableReload!="function"){window.postTableReload=function(){}}function e(e){e.wrap("<form>").closest("form")[0].reset();e.unwrap()}$("button").button();$('input[type="file"]').each(function(){var e=$("<span>",{"class":"fileinput-button-wrapper"});e.append($("<span>",{text:$(this).data("label")}));e.insertAfter($(this));e.button();$(this).detach().appendTo(e)});$("input.time").timepicker({timeFormat:"g:i a"});$("input.date").datepicker({dateFormat:"dd/mm/yy"});$("#edit_form input:submit, #import_csv_form input:submit").hide();$("form").each(function(){if($(this).find("input").first().is(".date, .time")){$(this).before('<input type="text" style="width: 0; height: 0; top: -100px; position: absolute;">')}});$("#edit_form").find("input:submit").before('<input type=hidden name="_method" value="POST" >');$("html").on("dragover",function(e){e.preventDefault();e.stopPropagation();$(this).addClass("draginside")});$("html").on("dragleave",function(e){e.preventDefault();e.stopPropagation();$(this).removeClass("draginside")});$("html").on("drop",function(e){e.preventDefault();e.stopPropagation()});if(typeof fos!="undefined"&&typeof fos.Router!="undefined"){fos.Router.prototype.generateIgnoringExtras=function(e,t,n){var i=this.generate(e,t,n);return i.replace(/\?.*$/,"")}}$.fn.addTransitionClass=function(e){var t=$.Deferred();$(this).addClass(e);$(this).on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",function(){t.resolveWith(this)});return t.promise()};var t=0;function n(){t+=1;$(".table_buttons .loading_spinner").show()}function i(){t-=1;if(t==0){$(".table_buttons .loading_spinner").hide()}}$.fn.isAnyTableRowSelected=function(){return $(this).hasClass("ui-selected")};$.fn.areAllTableRowsSelected=function(){return $(this).not("thead tr").not(".ui-selected").length==0};$.fn.isExactlyOneTableRowSelected=function(){return $(this).filter(".ui-selected").length==1};function a(e){if(typeof e==="undefined"){e=200}var t=$("tbody tr");if(!t.isAnyTableRowSelected()){$(".show_if_none_selected").show(e);$(".show_if_one_selected, .show_if_any_selected").hide(e)}else if(t.isExactlyOneTableRowSelected()){$(".show_if_one_selected, .show_if_any_selected").show(e);$(".show_if_none_selected").hide(e)}else{$(".show_if_any_selected").show(e);$(".show_if_none_selected, .show_if_one_selected").hide(e)}}a(0);function o(){var e=$("tbody").selectable({filter:"tr",stop:a});var t=e.data("uiSelectable")["_mouseStart"];e.data("uiSelectable")["_mouseStart"]=function(e){t.call(this,e);this.helper.css({top:-1,left:-1})};$("tbody tr").dblclick(u);$("abbr.timeago").timeago();$("tr.just_updated").removeClass("just_updated",1e3)}o();function r(){var e=$.Deferred();$("#admin_table_container").load(currentPath+"/table",function(){o();postTableReload();i();a();$(".ui-widget-overlay").height($(document).height());e.resolve()});n();return e.promise()}function s(e){return $("tbody tr").filter(function(){return $(this).data("entity").id===e})}$("#edit_dialog").dialog({autoOpen:false,modal:true,width:500,minWidth:500,height:500,dialogClass:"edit_dialog",buttons:[{text:"",click:function(){var e=$("#edit_form");e.data("reopen",false);e.find("input:submit").click()},"class":"submit_button"},{text:"Cancel",click:function(){$(this).dialog("close")},"class":"cancel_button"}]});function l(){x().done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").show();$(".delete_dialog .ui-dialog-buttonset button").button("disable");var e=false;var t=$("tbody tr.ui-selected").map(function(){var t=$(this).data("entity").id;var n=$.Deferred();$.ajax({type:"POST",data:{_method:"DELETE",fb:m},url:currentPath+"/"+t,dataType:"json"}).always(function(t){if(t.status!="success"){e=true}n.resolve()});return n.promise()});$.when.apply(null,t).done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").hide();$(".delete_dialog .ui-dialog-buttonset button").button("enable");if(!e){$("#delete_dialog").dialog("close");$("table tr.ui-selected").addClass("just_deleted");r()}})})}$("#delete_dialog").dialog({autoOpen:false,resizable:false,modal:true,width:400,dialogClass:"delete_dialog",buttons:{Delete:l,Cancel:function(){$(this).dialog("close")}}});$(".table_buttons .loading_spinner").clone().prependTo(".ui-dialog-buttonset");function d(){$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Create");$("#edit_dialog").dialog("open").dialog({title:"Add "+entitySingularTitle});var e=$("#edit_form");e.attr("method","POST");e.find('input[name="_method"]').val("POST");e.attr("action",currentPath);e.find("input, textarea").not(":button, :submit, :reset, :hidden, :radio, :checkbox").val("");e.find(".error").remove();e.find(".show_if_create").show();e.find(".show_if_edit").hide();e.data("form_mode","create");initCreateForm(e)}$("button.create").click(d);function u(){var e=$("tbody tr.ui-selected");if(e.length!=1)return;var t=e.first().data("entity");$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Save Changes");$("#edit_dialog").dialog("open").dialog({title:"Edit "+entitySingularTitle});var n=$("#edit_form");n.find('input[name="_method"]').val("PUT");n.attr("method","POST");n.find(".error").remove();n.find(".show_if_edit").show();n.find(".show_if_create").hide();n.data("form_mode","edit");n.attr("action",currentPath+"/"+t.id);n.find("input, select, textarea").not(":button, :submit, :reset, :hidden, :radio, :checkbox").each(function(){var e=$(this).attr("name");if(typeof e==="undefined")return;var n=e.split("[");n.splice(0,1);n=$.map(n,function(e){return e.split("]")[0]});var i=n[0];if(t.hasOwnProperty(i)){var a=t[i];if(a===false)a=0;else if(a===true)a=1;else if($(this).hasClass("date"))a=moment(parseInt(a)).format("DD/MM/YYYY");else if($(this).hasClass("time"))a=moment(parseInt(a)).format("h:mm a");else if(typeof a=="object"){if(a instanceof Array)a=null;else if($(this).prop("tagName")=="SELECT")a=a.id;else a=a.name}$(this).val(a)}else{$(this).val("")}});initEditForm(n,t)}$("button.edit").click(u);$("button.refresh").click(r);$("button.unselectall, #above_footer, #signupsfilter a").click(function(){$("tbody tr").removeClass("ui-selected");a()});$(".table_buttons button").click(function(e){e.stopPropagation()});$("button.submit_and_reopen").click(function(){var e=$(this).closest("form");e.data("reopen",true);e.find("input:submit").click();return false});$("button.delete").click(function(){$("#delete_dialog").dialog("open")});var f=function T(e,t,n){for(var i in n)if(n.hasOwnProperty(i)){var a=n[i];var o=t+"["+i+"]";if(typeof a=="string"){var r=$("<div>",{"class":"error",text:a});var s=e.find('*[name="'+o+'"]');if(s.length==0){s=e.find('*[name="'+t+'"]')}if(s.length==0){if(isNaN(i))r.text(i+": "+r.text());r.addClass("global_error").appendTo(e)}else{s.before(r)}}else if(typeof a=="object"){T(e,o,a)}}};$(".ui-dialog form").submit(function(){var e=$(this);var t=e.closest(".ui-dialog-content");var n=t.nextAll(".ui-dialog-buttonpane");var i=n.add(e).find("button");n.find(".loading_spinner").show();i.each(function(){$(this).data("was_disabled",$(this).prop("disabled"))});i.button("disable");e.find(".error").remove();var o,l,d;if(e.find("input:file").length!==0){o=new FormData(e[0]);l=false;d=false}else{o=e.serialize();l="application/x-www-form-urlencoded; charset=UTF-8";d=true}$.ajax({type:e.attr("method"),url:e.attr("action"),data:o,dataType:"json",cache:false,contentType:l,processData:d}).always(function(){n.find(".loading_spinner").hide();i.each(function(){if(!$(this).data("was_disabled")){$(this).button("enable")}})}).done(function(n){if(n.status=="success"){t.dialog("close");var i=r();if(e.data("reopen")===true){i.done(function(){var e=s(n.entity.id);e.addClass("ui-selected");a();$("button.edit").click()})}}else{if(n.status=="partial"){r()}f(e,"form",n.errors)}}).always(function(){e.data("reopen",null)});return false});(function(){var t=$("#edit_form.piece_of_music");if(t.length>0){var n=t.find("#add_files_button");var i=$("#piece_of_music_add_new_part_form");var a=t.find("ul#practice_parts");i.find('input[name="form[file]"]').remove();var o;(function(){var e=a.find("li.uploading-part").detach();o=function(){var t=e.clone();t.find(".progress-bar").progressbar({value:false});return t}})();var s;(function(){var e=a.find("li.part").detach();e.find("input").removeAttr("id");e.find(".a-button.delete").click(function(){$(this).closest("li.part").addTransitionClass("hidden").done(function(){$(this).remove()});return false});s=function(t){var n=e.clone(true);n.find("a.open").attr("href",Routing.generateIgnoringExtras("IcsePublicBundle_autoresource",t));["instrument","sort_index"].forEach(function(e){var i=n.find("input."+e);i.val(t[e]);i.attr("name",i.attr("name").replace("__ID__",t.id))});return n}})();var l=function(){a.find("li").each(function(){$(this).find("input.sort_index").val($(this).index())})};a.sortable({placeholder:"drag-placeholder",cancel:"a,.a-button,input",update:l});var d=function(){var e=a.find("li").map(function(){return $(this).find("input.sort_index").val()});return e.length==0?-1:Math.max.apply(null,e)};var u=function(e,t){var n=t.find("button");var u=t.find(".loading_spinner");var f=d()+1;i.find('input[name="form[sort_index]"]').val(f);var c=o();c.find(".name").text(e.name);var p=c.find(".progress-bar");c.find("input.sort_index").val(f);c.hide();a.append(c);c.show(500);var h=new FormData(i[0]);h.append("form[file]",e);n.button("disable");u.show();var m=false;$.ajax({url:i.attr("action").replace("__ID__",a.data("piece_id")),type:"POST",data:h,dataType:"json",processData:false,contentType:false,xhr:function(){xhr=$.ajaxSettings.xhr();if(xhr.upload){xhr.upload.addEventListener("progress",function(e){if(e.lengthComputable){p.progressbar({value:e.loaded,max:e.total})}},false)}return xhr}}).done(function(e){if(e.status=="success"){var t=s(e.entity);c.replaceWith(t);m=true}}).always(function(){if(!m)c.remove();if(a.find(".uploading-part").length===0){n.button("enable");u.hide();l();r()}})};n.change(function(){var t=$(this).closest(".ui-dialog-content").nextAll(".ui-dialog-buttonpane");for(var n=0;n<this.files.length;n++){u(this.files[n],t)}e($(this))});var f=t.find("#practice_parts_section");var c=f.find("#drop_mask");f.on("dragenter",function(e){if(t.data("form_mode")=="edit"){e.stopPropagation();e.preventDefault();f.addClass("draginside");c.height(f.outerHeight())}});c.on("dragleave",function(e){e.stopPropagation();e.preventDefault();f.removeClass("draginside")});c.on("drop",function(e){e.stopPropagation();e.preventDefault();f.removeClass("draginside");var t=f.closest(".ui-dialog-content").nextAll(".ui-dialog-buttonpane");var n=e.originalEvent.dataTransfer.files;for(var i=0;i<n.length;i++){u(n[i],t)}});window.initCreateForm=function(){a.empty()};window.initEditForm=function(e,t){a.data("piece_id",t.id);var n=t.practice_parts;a.empty();n.forEach(function(e){var t=s(e);a.append(t)})}}})();function c(e){var t=$.Deferred();$("<div>").html(e).dialog({close:function(){t.resolve()},resizable:false,closeOnEscape:false,buttons:{Okay:function(){$(this).dialog("close")}}});return t.promise()}function p(e){var t=$.Deferred();var n=$("<div>").html(e).dialog({resizable:false,closeOnEscape:false,open:function(){$(this).parent().find(".ui-dialog-titlebar-close").hide()},modal:true});t.always(function(){n.dialog("close")});return t}var h=false;var m=null;var b=["create_event","manage_pages"];function v(e){h=e.status==="connected"}if(enable_social_net){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_UK/all.js",function(){FB.init({appId:facebookAppId,status:true});FB.Event.subscribe("auth.authResponseChange",v);$("button.social_sync").button("option","disabled",false)})}function _(){var e=$.Deferred();FB.login(function(t){v(t);if(h){e.resolve()}else{e.reject()}},{scope:b.join(",")});return e.promise()}function g(e,t){_().done(function(){e(t)}).fail(function(){t.reject()})}function y(e){var t=$.Deferred();console.log("Already connected:",h);if(h){e($.Deferred()).done(function(){console.log("Success first time");t.resolve()}).fail(function(){c("Click to reconnect to Facebook.").always(function(){g(e,t)})})}else{g(e,t)}return t.promise()}function w(){if(m!==null){return $.when()}else{return y(function(e){FB.api("/me/accounts/",function(t){var n=false;if($.isArray(t.data))for(var i=0;i<t.data.length;i++){var a=t.data[i];if(a.id===facebookPageId){console.log(a.name,a.access_token);m=a.access_token;n=true;break}}n?e.resolve():e.reject()});return e.promise()})}}function x(){if(enable_social_net){return $.when(w())}else{return $.when()}}$("button.social_sync").button().click(function(){x().done(function(){var e=p("Synchronising changes to social networks...");var t=$("tbody tr.ui-selected").map(function(){var e=$(this).data("entity").id;var t=$.Deferred();$.ajax({type:"POST",url:currentPath+"/"+e+"?"+$.param({op:"socialnetsync"}),data:{fb:m},dataType:"json"}).always(function(e){if(e.status=="fail"){m=null}t.resolve()});return t.promise()});$.when.apply(null,t).done(function(){e.resolve();r()})})})})();