(function(){if(typeof initCreateForm!="function"){window.initCreateForm=function(){}}if(typeof initEditForm!="function"){window.initEditForm=function(){}}if(typeof postTableReload!="function"){window.postTableReload=function(){}}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};$("button").button();$("input.time").timepicker({timeFormat:"g:i a"});$("input.date").datepicker({dateFormat:"dd/mm/yy"});$("#edit_form input:submit, #import_csv_form input:submit").hide();$("form").each(function(){if($(this).find("input").first().is(".date, .time")){$(this).before('<input type="text" style="width: 0; height: 0; top: -100px; position: absolute;">')}});$("#edit_form").find("input:submit").before('<input type=hidden name="_method" value="POST" >');var f=0;function a(){f+=1;$(".table_buttons .loading_spinner").show()}function m(){f-=1;if(f==0){$(".table_buttons .loading_spinner").hide()}}$.fn.isAnyTableRowSelected=function(){return $(this).hasClass("ui-selected")};$.fn.areAllTableRowsSelected=function(){return $(this).not("thead tr").not(".ui-selected").length==0};$.fn.isExactlyOneTableRowSelected=function(){return $(this).filter(".ui-selected").length==1};function b(v){if(typeof v==="undefined"){v=200}var u=$("tbody tr");if(!u.isAnyTableRowSelected()){$(".show_if_none_selected").show(v);$(".show_if_one_selected, .show_if_any_selected").hide(v)}else{if(u.isExactlyOneTableRowSelected()){$(".show_if_one_selected, .show_if_any_selected").show(v);$(".show_if_none_selected").hide(v)}else{$(".show_if_any_selected").show(v);$(".show_if_none_selected, .show_if_one_selected").hide(v)}}}b(0);function e(){var u=$("tbody").selectable({filter:"tr",stop:b});var v=u.data("uiSelectable")["_mouseStart"];u.data("uiSelectable")["_mouseStart"]=function(w){v.call(this,w);this.helper.css({top:-1,left:-1})};$("tbody tr").dblclick(i);$("abbr.timeago").timeago();$("tr.just_updated").removeClass("just_updated",1000)}e();function l(){$("#admin_table_container").load(currentPath+"/table",function(){e();postTableReload();m();b();$(".ui-widget-overlay").height($(document).height())});a()}$("#edit_dialog").dialog({autoOpen:false,modal:true,width:500,minWidth:500,height:500,dialogClass:"edit_dialog",buttons:[{text:"",click:function(){$("#edit_form").find("input:submit").click()},"class":"submit_button"},{text:"Cancel",click:function(){$(this).dialog("close")},"class":"cancel_button"}]});function t(){g().done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").show();$(".delete_dialog .ui-dialog-buttonset button").button("disable");var u=false;var v=$("tbody tr.ui-selected").map(function(){var x=$(this).data("entity").id;var w=$.Deferred();$.ajax({type:"POST",data:{_method:"DELETE",fb:n},url:currentPath+"/"+x,dataType:"json"}).always(function(y){if(y.status!="success"){u=true}w.resolve()});return w.promise()});$.when.apply(null,v).done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").hide();$(".delete_dialog .ui-dialog-buttonset button").button("enable");if(!u){$("#delete_dialog").dialog("close");$("table tr.ui-selected").addClass("just_deleted");l()}})})}$("#delete_dialog").dialog({autoOpen:false,resizable:false,modal:true,width:400,dialogClass:"delete_dialog",buttons:{Delete:t,Cancel:function(){$(this).dialog("close")}}});$(".table_buttons .loading_spinner").clone().prependTo(".ui-dialog-buttonset");function d(){$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Create");$("#edit_dialog").dialog("open").dialog({title:"Add "+entitySingular.capitalize()});var u=$("#edit_form");u.attr("method","POST");u.find('input[name="_method"]').val("POST");u.attr("action",currentPath);u.find("input, textarea").not(":button, :submit, :reset, :hidden, :radio, :checkbox").val("");u.find(".error").remove();initCreateForm()}$("button.create").click(d);function i(){var w=$("tbody tr.ui-selected");if(w.length!=1){return}var u=w.first().data("entity");$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Save Changes");$("#edit_dialog").dialog("open").dialog({title:"Edit "+entitySingular.capitalize()});var v=$("#edit_form");v.find('input[name="_method"]').val("PUT");v.attr("method","POST");v.find(".error").remove();v.attr("action",currentPath+"/"+u.id);v.find("input, select, textarea").not(":button, :submit, :reset, :hidden, :radio, :checkbox").each(function(){var z=$(this).attr("name").split("[");z.splice(0,1);z=$.map(z,function(A){return A.split("]")[0]});var x=z[0];if(u.hasOwnProperty(x)){var y=u[x];if(y===false){y=0}else{if(y===true){y=1}}if(z[1]=="date"){y=moment(parseInt(y)).format("DD/MM/YYYY")}if(z[1]=="time"){y=moment(parseInt(y)).format("h:mm a")}if(typeof y=="object"){if($(this).prop("tagName")=="SELECT"){y=y.id}else{y=y.name}}$(this).val(y)}else{$(this).val("")}});initEditForm()}$("button.edit").click(i);$("button.refresh").click(l);$("button.unselectall, #above_footer, #signupsfilter a").click(function(){$("tbody tr").removeClass("ui-selected");b()});$(".table_buttons button").click(function(u){u.stopPropagation()});$("button.delete").click(function(){$("#delete_dialog").dialog("open")});$(".ui-dialog form").submit(function(){var v=$(this);var u=v.closest(".ui-dialog-content");var x=u.nextAll(".ui-dialog-buttonpane");var w,z,y;if(v.find("input:file").length!==0){w=new FormData(v[0]);z=false;y=false}else{w=v.serialize();z="application/x-www-form-urlencoded; charset=UTF-8";y=true}$.ajax({type:v.attr("method"),url:v.attr("action"),data:w,dataType:"json",cache:false,contentType:z,processData:y,complete:function(A){}}).always(function(){x.find(".loading_spinner").hide();x.find("button").button("enable")}).done(function(A){if(A.status=="success"){u.dialog("close");l()}else{if(A.status=="partial"){l()}for(var C in A.errors){if(A.errors.hasOwnProperty(C)){var B=$("<div>",{"class":"error",text:(function(){var E=A.errors[C];if(typeof E==="string"){return E}else{if(typeof E==="object"&&typeof E.first==="object"){return E.first[0]}else{return E[0]}}})()});var D=v.find('*[name*="['+C+']"]');if(isNaN(C)&&D.length!==0){D.before(B)}else{if(isNaN(C)){B.html(C+": "+B.html())}B.addClass("global_error").appendTo(v)}}}}});x.find(".loading_spinner").show();x.find("button").button("disable");v.find(".error").remove();return false});function r(v){var u=$.Deferred();$("<div>").html(v).dialog({close:function(){u.resolve()},resizable:false,closeOnEscape:false,buttons:{Okay:function(){$(this).dialog("close")}}});return u.promise()}function s(w){var u=$.Deferred();var v=$("<div>").html(w).dialog({resizable:false,closeOnEscape:false,open:function(){$(this).parent().find(".ui-dialog-titlebar-close").hide()},modal:true});u.always(function(){v.dialog("close")});return u}var p=false;var n=null;var k=["create_event","manage_pages"];function c(u){p=(u.status==="connected")}if(enable_social_net){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_UK/all.js",function(){FB.init({appId:facebookAppId,status:true});FB.Event.subscribe("auth.authResponseChange",c);$("button.social_sync").button("option","disabled",false)})}function j(){var u=$.Deferred();FB.login(function(v){c(v);if(p){u.resolve()}else{u.reject()}},{scope:k.join(",")});return u.promise()}function h(v,u){j().done(function(){v(u)}).fail(function(){u.reject()})}function o(v){var u=$.Deferred();console.log("Already connected:",p);if(p){v($.Deferred()).done(function(){console.log("Success first time");u.resolve()}).fail(function(){r("Click to reconnect to Facebook.").always(function(){h(v,u)})})}else{h(v,u)}return u.promise()}function q(){if(n!==null){return $.when()}else{return o(function(u){FB.api("/me/accounts/",function(v){var y=false;if($.isArray(v.data)){for(var w=0;w<v.data.length;w++){var x=v.data[w];if(x.id===facebookPageId){console.log(x.name,x.access_token);n=x.access_token;y=true;break}}}y?u.resolve():u.reject()});return u.promise()})}}function g(){if(enable_social_net){return $.when(q())}else{return $.when()}}$("button.social_sync").button().click(function(){g().done(function(){var v=s("Synchronising changes to social networks...");var u=$("tbody tr.ui-selected").map(function(){var x=$(this).data("entity").id;var w=$.Deferred();$.ajax({type:"POST",url:currentPath+"/"+x+"?"+$.param({op:"socialnetsync"}),data:{fb:n},dataType:"json"}).always(function(y){if(y.status=="fail"){n=null}w.resolve()});return w.promise()});$.when.apply(null,u).done(function(){v.resolve();l()})})})})();