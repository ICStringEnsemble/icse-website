(function(){if(typeof initCreateForm!="function"){window.initCreateForm=function(){}}if(typeof initEditForm!="function"){window.initEditForm=function(){}}if(typeof postTableReload!="function"){window.postTableReload=function(){}}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};$("button").button();$("input.time").timepicker({timeFormat:"g:i a"});$("input.date").datepicker({dateFormat:"dd/mm/yy"});$("#edit_form input:submit, #import_csv_form input:submit").hide();$("form").each(function(){if($(this).find("input").first().is(".date, .time")){$(this).before('<input type="text" style="width: 0; height: 0; top: -100px; position: absolute;">')}});$("#edit_form").find("input:submit").before('<input type=hidden name="_method" value="POST" >');var e=0;function t(){e+=1;$(".table_buttons .loading_spinner").show()}function i(){e-=1;if(e==0){$(".table_buttons .loading_spinner").hide()}}$.fn.isAnyTableRowSelected=function(){return $(this).hasClass("ui-selected")};$.fn.areAllTableRowsSelected=function(){return $(this).not("thead tr").not(".ui-selected").length==0};$.fn.isExactlyOneTableRowSelected=function(){return $(this).filter(".ui-selected").length==1};function n(e){if(typeof e==="undefined"){e=200}var t=$("tbody tr");if(!t.isAnyTableRowSelected()){$(".show_if_none_selected").show(e);$(".show_if_one_selected, .show_if_any_selected").hide(e)}else if(t.isExactlyOneTableRowSelected()){$(".show_if_one_selected, .show_if_any_selected").show(e);$(".show_if_none_selected").hide(e)}else{$(".show_if_any_selected").show(e);$(".show_if_none_selected, .show_if_one_selected").hide(e)}}n(0);function o(){var e=$("tbody").selectable({filter:"tr",stop:n});var t=e.data("uiSelectable")["_mouseStart"];e.data("uiSelectable")["_mouseStart"]=function(e){t.call(this,e);this.helper.css({top:-1,left:-1})};$("tbody tr").dblclick(r);$("abbr.timeago").timeago();$("tr.just_updated").removeClass("just_updated",1e3)}o();function a(){$("#admin_table_container").load(currentPath+"/table",function(){o();postTableReload();i();n();$(".ui-widget-overlay").height($(document).height())});t()}$("#edit_dialog").dialog({autoOpen:false,modal:true,width:500,minWidth:500,height:500,dialogClass:"edit_dialog",buttons:[{text:"",click:function(){$("#edit_form").find("input:submit").click()},"class":"submit_button"},{text:"Cancel",click:function(){$(this).dialog("close")},"class":"cancel_button"}]});function l(){v().done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").show();$(".delete_dialog .ui-dialog-buttonset button").button("disable");var e=false;var t=$("tbody tr.ui-selected").map(function(){var t=$(this).data("entity").id;var i=$.Deferred();$.ajax({type:"POST",data:{_method:"DELETE",fb:f},url:currentPath+"/"+t,dataType:"json"}).always(function(t){if(t.status!="success"){e=true}i.resolve()});return i.promise()});$.when.apply(null,t).done(function(){$(".delete_dialog .ui-dialog-buttonset .loading_spinner").hide();$(".delete_dialog .ui-dialog-buttonset button").button("enable");if(!e){$("#delete_dialog").dialog("close");$("table tr.ui-selected").addClass("just_deleted");a()}})})}$("#delete_dialog").dialog({autoOpen:false,resizable:false,modal:true,width:400,dialogClass:"delete_dialog",buttons:{Delete:l,Cancel:function(){$(this).dialog("close")}}});$(".table_buttons .loading_spinner").clone().prependTo(".ui-dialog-buttonset");function s(){$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Create");$("#edit_dialog").dialog("open").dialog({title:"Add "+entitySingular.capitalize()});var e=$("#edit_form");e.attr("method","POST");e.find('input[name="_method"]').val("POST");e.attr("action",currentPath);e.find("input, textarea").not(":button, :submit, :reset, :hidden, :radio, :checkbox").val("");e.find(".error").remove();initCreateForm()}$("button.create").click(s);function r(){var e=$("tbody tr.ui-selected");if(e.length!=1)return;var t=e.first().data("entity");$(".edit_dialog .ui-dialog-buttonset .submit_button .ui-button-text").html("Save Changes");$("#edit_dialog").dialog("open").dialog({title:"Edit "+entitySingular.capitalize()});var i=$("#edit_form");i.find('input[name="_method"]').val("PUT");i.attr("method","POST");i.find(".error").remove();i.attr("action",currentPath+"/"+t.id);i.find("input, select, textarea").not(":button, :submit, :reset, :hidden, :radio, :checkbox").each(function(){var e=$(this).attr("name").split("[");e.splice(0,1);e=$.map(e,function(e){return e.split("]")[0]});var i=e[0];if(t.hasOwnProperty(i)){var n=t[i];if(n===false)n=0;else if(n===true)n=1;if($(this).hasClass("date"))n=moment(parseInt(n)).format("DD/MM/YYYY");if($(this).hasClass("time"))n=moment(parseInt(n)).format("h:mm a");if(typeof n=="object"){if($(this).prop("tagName")=="SELECT")n=n.id;else n=n.name}$(this).val(n)}else{$(this).val("")}});initEditForm()}$("button.edit").click(r);$("button.refresh").click(a);$("button.unselectall, #above_footer, #signupsfilter a").click(function(){$("tbody tr").removeClass("ui-selected");n()});$(".table_buttons button").click(function(e){e.stopPropagation()});$("button.delete").click(function(){$("#delete_dialog").dialog("open")});$(".ui-dialog form").submit(function(){var e=$(this);var t=e.closest(".ui-dialog-content");var i=t.nextAll(".ui-dialog-buttonpane");var n,o,l;if(e.find("input:file").length!==0){n=new FormData(e[0]);o=false;l=false}else{n=e.serialize();o="application/x-www-form-urlencoded; charset=UTF-8";l=true}$.ajax({type:e.attr("method"),url:e.attr("action"),data:n,dataType:"json",cache:false,contentType:o,processData:l,complete:function(e){}}).always(function(){i.find(".loading_spinner").hide();i.find("button").button("enable")}).done(function(i){if(i.status=="success"){t.dialog("close");a()}else{if(i.status=="partial"){a()}for(var n in i.errors){if(i.errors.hasOwnProperty(n)){var o=$("<div>",{"class":"error",text:function(){var e=i.errors[n];if(typeof e==="string"){return e}else if(typeof e==="object"&&typeof e.first==="object"){return e.first[0]}else{return e[0]}}()});var l=e.find('*[name*="['+n+']"]');if(isNaN(n)&&l.length!==0){l.before(o)}else{if(isNaN(n)){o.html(n+": "+o.html())}o.addClass("global_error").appendTo(e)}}}}});i.find(".loading_spinner").show();i.find("button").button("disable");e.find(".error").remove();return false});function d(e){var t=$.Deferred();$("<div>").html(e).dialog({close:function(){t.resolve()},resizable:false,closeOnEscape:false,buttons:{Okay:function(){$(this).dialog("close")}}});return t.promise()}function u(e){var t=$.Deferred();var i=$("<div>").html(e).dialog({resizable:false,closeOnEscape:false,open:function(){$(this).parent().find(".ui-dialog-titlebar-close").hide()},modal:true});t.always(function(){i.dialog("close")});return t}var c=false;var f=null;var p=["create_event","manage_pages"];function b(e){c=e.status==="connected"}if(enable_social_net){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_UK/all.js",function(){FB.init({appId:facebookAppId,status:true});FB.Event.subscribe("auth.authResponseChange",b);$("button.social_sync").button("option","disabled",false)})}function h(){var e=$.Deferred();FB.login(function(t){b(t);if(c){e.resolve()}else{e.reject()}},{scope:p.join(",")});return e.promise()}function m(e,t){h().done(function(){e(t)}).fail(function(){t.reject()})}function _(e){var t=$.Deferred();console.log("Already connected:",c);if(c){e($.Deferred()).done(function(){console.log("Success first time");t.resolve()}).fail(function(){d("Click to reconnect to Facebook.").always(function(){m(e,t)})})}else{m(e,t)}return t.promise()}function g(){if(f!==null){return $.when()}else{return _(function(e){FB.api("/me/accounts/",function(t){var i=false;if($.isArray(t.data))for(var n=0;n<t.data.length;n++){var o=t.data[n];if(o.id===facebookPageId){console.log(o.name,o.access_token);f=o.access_token;i=true;break}}i?e.resolve():e.reject()});return e.promise()})}}function v(){if(enable_social_net){return $.when(g())}else{return $.when()}}$("button.social_sync").button().click(function(){v().done(function(){var e=u("Synchronising changes to social networks...");var t=$("tbody tr.ui-selected").map(function(){var e=$(this).data("entity").id;var t=$.Deferred();$.ajax({type:"POST",url:currentPath+"/"+e+"?"+$.param({op:"socialnetsync"}),data:{fb:f},dataType:"json"}).always(function(e){if(e.status=="fail"){f=null}t.resolve()});return t.promise()});$.when.apply(null,t).done(function(){e.resolve();a()})})})})();